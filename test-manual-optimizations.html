<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Performance Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-panel {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .metric {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a8a4a;
        }
        button {
            background: #4a4a8a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a5a9a;
        }
        .log {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Manual Performance Test</h1>
    
    <div class="test-panel">
        <h2>Performance Metrics</h2>
        <div class="metric">
            <div class="metric-value" id="dom-queries">0</div>
            <div>DOM Queries</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="parameter-updates">0</div>
            <div>Parameter Updates</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="memory-usage">0</div>
            <div>Memory (MB)</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="execution-time">0</div>
            <div>Time (ms)</div>
        </div>
    </div>

    <div class="test-panel">
        <h2>DOM Caching Test</h2>
        <p>Test DOM element caching performance</p>
        <button onclick="testDOMCaching()">Test DOM Caching</button>
        <div class="log" id="dom-log"></div>
    </div>

    <div class="test-panel">
        <h2>Parameter Handler Test</h2>
        <p>Test unified parameter handler performance</p>
        <button onclick="testParameterHandler()">Test Parameter Handler</button>
        <div class="log" id="parameter-log"></div>
    </div>

    <div class="test-panel">
        <h2>Memory Management Test</h2>
        <p>Test memory cleanup and abort controllers</p>
        <button onclick="testMemoryManagement()">Test Memory Management</button>
        <div class="log" id="memory-log"></div>
    </div>

    <div class="test-panel">
        <h2>Real Application Test</h2>
        <p>Test optimizations in the actual application</p>
        <button onclick="testRealApp()">Test Real App</button>
        <div class="log" id="app-log"></div>
    </div>

    <script type="module">
        import { App } from './src/core/App.js';

        let app;
        let metrics = {
            domQueries: 0,
            parameterUpdates: 0,
            memoryUsage: 0,
            executionTime: 0
        };

        function log(containerId, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
        }

        function updateMetrics() {
            document.getElementById('dom-queries').textContent = metrics.domQueries;
            document.getElementById('parameter-updates').textContent = metrics.parameterUpdates;
            document.getElementById('memory-usage').textContent = metrics.memoryUsage;
            document.getElementById('execution-time').textContent = metrics.executionTime.toFixed(2);
        }

        window.testDOMCaching = async () => {
            const logContainer = 'dom-log';
            log(logContainer, 'Starting DOM caching test...');

            try {
                // Initialize app
                app = new App();
                log(logContainer, 'App initialized');

                // Test DOM cache initialization
                app.initializeDOMCache();
                log(logContainer, 'DOM cache initialized');

                // Performance test
                const startTime = performance.now();
                for (let i = 0; i < 1000; i++) {
                    app.getCachedElement('midi-connect');
                    metrics.domQueries++;
                }
                const cachedTime = performance.now() - startTime;

                const startTime2 = performance.now();
                for (let i = 0; i < 1000; i++) {
                    document.getElementById('midi-connect');
                }
                const directTime = performance.now() - startTime2;

                metrics.executionTime = cachedTime;

                log(logContainer, `Cached queries: ${cachedTime.toFixed(2)}ms`);
                log(logContainer, `Direct queries: ${directTime.toFixed(2)}ms`);
                
                if (cachedTime < directTime) {
                    const improvement = ((directTime - cachedTime) / directTime * 100).toFixed(1);
                    log(logContainer, `✅ Performance improvement: ${improvement}% faster`);
                } else {
                    log(logContainer, '❌ No performance improvement detected');
                }

                updateMetrics();

            } catch (error) {
                log(logContainer, `❌ Error: ${error.message}`);
            }
        };

        window.testParameterHandler = async () => {
            const logContainer = 'parameter-log';
            log(logContainer, 'Starting parameter handler test...');

            try {
                // Initialize app
                app = new App();
                await app.init();
                log(logContainer, 'App initialized');

                // Test parameter handler configuration
                if (App.PARAMETER_HANDLERS && App.PARAMETER_HANDLERS.size > 0) {
                    log(logContainer, `✅ Parameter handler configured with ${App.PARAMETER_HANDLERS.size} parameters`);
                } else {
                    log(logContainer, '❌ Parameter handler not configured');
                    return;
                }

                // Performance test
                const startTime = performance.now();
                const testParameters = [
                    'movementAmplitude',
                    'rotationAmplitude',
                    'scaleAmplitude',
                    'gridWidth',
                    'bloomStrength'
                ];

                for (let i = 0; i < 1000; i++) {
                    const param = testParameters[i % testParameters.length];
                    app.handleParameterUpdate(param, Math.random());
                    metrics.parameterUpdates++;
                }

                const updateTime = performance.now() - startTime;
                metrics.executionTime = updateTime;

                log(logContainer, `✅ 1000 parameter updates completed in ${updateTime.toFixed(2)}ms`);
                log(logContainer, `Average time per update: ${(updateTime / 1000).toFixed(3)}ms`);

                updateMetrics();

            } catch (error) {
                log(logContainer, `❌ Error: ${error.message}`);
            }
        };

        window.testMemoryManagement = async () => {
            const logContainer = 'memory-log';
            log(logContainer, 'Starting memory management test...');

            try {
                // Initialize app
                app = new App();
                await app.init();
                log(logContainer, 'App initialized');

                // Test abort controllers
                if (app.abortControllers && app.abortControllers instanceof Map) {
                    log(logContainer, '✅ Abort controllers initialized');
                } else {
                    log(logContainer, '❌ Abort controllers not initialized');
                    return;
                }

                // Test event listener tracking
                if (app.eventListeners && Array.isArray(app.eventListeners)) {
                    log(logContainer, '✅ Event listener tracking initialized');
                } else {
                    log(logContainer, '❌ Event listener tracking not initialized');
                    return;
                }

                // Test cleanup
                const initialCount = app.eventListeners.length;
                app.addTrackedEventListener(document.createElement('button'), 'click', () => {});
                log(logContainer, `Event listeners before cleanup: ${app.eventListeners.length}`);

                app.removeAllEventListeners();
                log(logContainer, `Event listeners after cleanup: ${app.eventListeners.length}`);

                if (app.eventListeners.length === 0) {
                    log(logContainer, '✅ Event listener cleanup working');
                } else {
                    log(logContainer, '❌ Event listener cleanup failed');
                }

                // Test abort controller cleanup
                app.abortControllers.set('test', new AbortController());
                log(logContainer, `Abort controllers before cleanup: ${app.abortControllers.size}`);

                app.cleanup();
                log(logContainer, `Abort controllers after cleanup: ${app.abortControllers.size}`);

                if (app.abortControllers.size === 0) {
                    log(logContainer, '✅ Abort controller cleanup working');
                } else {
                    log(logContainer, '❌ Abort controller cleanup failed');
                }

                // Memory usage
                if (performance.memory) {
                    metrics.memoryUsage = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    log(logContainer, `Memory usage: ${metrics.memoryUsage}MB`);
                }

                updateMetrics();

            } catch (error) {
                log(logContainer, `❌ Error: ${error.message}`);
            }
        };

        window.testRealApp = async () => {
            const logContainer = 'app-log';
            log(logContainer, 'Starting real application test...');

            try {
                // Initialize app
                app = new App();
                await app.init();
                log(logContainer, 'App initialized successfully');

                // Test DOM caching in real context
                app.initializeDOMCache();
                log(logContainer, 'DOM cache initialized');

                // Test parameter handling in real context
                const testParams = ['movementAmplitude', 'rotationAmplitude', 'scaleAmplitude'];
                for (const param of testParams) {
                    const originalValue = app.state.get(param);
                    app.handleParameterUpdate(param, 0.5);
                    const newValue = app.state.get(param);
                    log(logContainer, `${param}: ${originalValue} → ${newValue}`);
                }

                // Test memory management
                const initialMemory = performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 0;
                log(logContainer, `Initial memory: ${initialMemory}MB`);

                // Simulate some operations
                for (let i = 0; i < 100; i++) {
                    app.handleParameterUpdate('movementAmplitude', Math.random());
                    app.getCachedElement('midi-connect');
                }

                const finalMemory = performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 0;
                log(logContainer, `Final memory: ${finalMemory}MB`);

                if (finalMemory <= initialMemory + 5) { // Allow small increase
                    log(logContainer, '✅ Memory usage stable');
                } else {
                    log(logContainer, '⚠️ Memory usage increased significantly');
                }

                // Test cleanup
                app.cleanup();
                log(logContainer, '✅ App cleanup completed');

                log(logContainer, '🎉 Real application test completed successfully!');

            } catch (error) {
                log(logContainer, `❌ Error: ${error.message}`);
            }
        };

        // Initialize metrics display
        updateMetrics();
    </script>
</body>
</html> 